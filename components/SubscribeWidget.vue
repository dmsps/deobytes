<template>
    <div class="subscribe">
        <el-popover placement="top" width="320" v-model="isVisible" @hide="toggleVisible(true)">
            <div>
                <template v-if="!isFormSended">
                    <h3 style="color: black; margin-bottom: 10px">
                        –û—Ç–ø—Ä–∞–≤–∏–º –ø—Ä–µ–¥–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–æ—á—Ç—É ü§ü
                    </h3>
                    <el-form
                        :model="ruleForm"
                        :rules="rules"
                        ref="ruleForm"
                        :hide-required-asterisk="true"
                        size="small"
                    >
                        <el-form-item label="Email" prop="email">
                            <el-input v-model="ruleForm.email" size="medium"></el-input>
                        </el-form-item>
                        <el-form-item style="text-align: right">
                            <el-button size="small" type="text" @click="toggleVisible(false)">
                                –ï—â–µ –ø–æ–¥—É–º–∞—é
                            </el-button>
                            <el-button size="small" type="primary" @click="submitForm('ruleForm')">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </el-button>
                        </el-form-item>
                    </el-form>
                </template>
                <h3 v-else style="color: black">
                    –°–ø–∞—Å–∏–±–æ, –Ω–∞—à–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è
                </h3>
            </div>
            <button
                slot="reference"
                type="button"
                @mouseenter="toggleHover"
                @mouseleave="toggleHover"
                :class="['subscribe__wrapper', { active: isHovered }]"
            >
                <i style="font-size: 26px" class="el-icon-message subscribe__icon"></i>
                <div class="subscribe__title">–ó–∞–∫–∞–∑–∞—Ç—å –¥–µ–º–æ</div>
            </button>
        </el-popover>
    </div>
</template>
<script>
export default {
    name: "SubscribeWidget",
    data() {
        return {
            isVisible: false,
            isHovered: false,
            isFormSended: false,
            ruleForm: {
                email: "",
            },
            rules: {
                email: [
                    { required: true, message: "–£–∫–∞–∂–∏—Ç–µ email", trigger: "blur" },
                    { type: "email", message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email", trigger: "blur" },
                ],
            },
        }
    },
    methods: {
        toggleHover() {
            if (this.isVisible) return
            this.isHovered = !this.isHovered
        },
        toggleVisible(force) {
            if (!force) {
                this.isVisible = !this.isVisible
            }
            if (this.isHovered) {
                this.toggleHover()
            }
        },
        submitForm(formName) {
            this.$refs[formName].validate(async valid => {
                if (valid) {
                    // location.href = `mailto:join@deobytes.ru?subject=${this.ruleForm.email} –∑–∞–∫–∞–∑—ã–≤–∞—é –¥–µ–º–æ-–¥–æ—Å—Ç—É–ø –≤ Deobytes`
                    const data = await this.$axios.post("/send.php", {
                        email: this.ruleForm.email,
                    })

                    if (data) {
                        this.isFormSended = true
                    }
                }
            })
        },
        clear() {
            this.ruleForm.email = ""
        },
    },
}
</script>
